name: Generate AdShare Session Cookies

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'AdShare Username/Email'
        required: true
        type: string
      password:
        description: 'AdShare Password'
        required: true
        type: string

jobs:
  generate-cookies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4
    
    - name: Run login script
      env:
        ADSHARE_USER: ${{ inputs.username }}
        ADSHARE_PASS: ${{ inputs.password }}
      run: |
        echo "Starting AdShare login..."
        python adshare_login.py "$ADSHARE_USER" "$ADSHARE_PASS"
    
    - name: Display cookies content
      if: success()
      run: |
        echo "=== Cookies File Content ==="
        if [ -f "cookies.txt" ]; then
          cat cookies.txt
          echo "=============================="
        else
          echo "ERROR: cookies.txt not generated!"
          exit 1
        fi
    
    - name: Upload cookies artifact
      uses: actions/upload-artifact@v4
      with:
        name: adshare-cookies-netscape
        path: cookies.txt
        retention-days: 1
        if-no-files-found: error
    
    - name: Create cookie usage examples
      if: success()
      run: |
        echo "=== Cookie Usage Examples ===" > USAGE.md
        echo "" >> USAGE.md
        echo "## Using with curl:" >> USAGE.md
        echo '```bash' >> USAGE.md
        echo "curl -b cookies.txt -c cookies.txt 'https://adsha.re/account'" >> USAGE.md
        echo '```' >> USAGE.md
        echo "" >> USAGE.md
        echo "## Using with wget:" >> USAGE.md
        echo '```bash' >> USAGE.md
        echo "wget --load-cookies cookies.txt 'https://adsha.re/account'" >> USAGE.md
        echo '```' >> USAGE.md
        echo "" >> USAGE.md
        echo "## Using with Python requests:" >> USAGE.md
        echo '```python' >> USAGE.md
        echo "import requests" >> USAGE.md
        echo "from http.cookiejar import MozillaCookieJar" >> USAGE.md
        echo "" >> USAGE.md
        echo "# Load cookies" >> USAGE.md
        echo "jar = MozillaCookieJar('cookies.txt')" >> USAGE.md
        echo "jar.load(ignore_discard=True, ignore_expires=True)" >> USAGE.md
        echo "" >> USAGE.md
        echo "# Use in session" >> USAGE.md
        echo "session = requests.Session()" >> USAGE.md
        echo "session.cookies.update(jar)" >> USAGE.md
        echo "response = session.get('https://adsha.re/account')" >> USAGE.md
        echo '```' >> USAGE.md
    
    - name: Upload usage documentation
      uses: actions/upload-artifact@v4
      with:
        name: cookie-usage-guide
        path: USAGE.md
    
    - name: Cleanup sensitive files
      if: always()
      run: |
        echo "Cleaning up sensitive files..."
        rm -f cookies.txt USAGE.md
        echo "Cleanup complete."
