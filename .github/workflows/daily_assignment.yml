name: Daily Visitor Assignment

on:
  schedule:
    # Run daily at 12:15 UTC (5:45 PM IST) - random time between 5:30-6:00 PM IST
    - cron: '15 12 * * *'  # 12:15 UTC = 5:45 PM IST (within target range)
  workflow_dispatch: # Allow manual trigger

jobs:
  run-daily-assignment:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent long runs
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 pytz

    - name: Download cookies from previous run
      uses: actions/download-artifact@v4
      with:
        name: session-cookies
        path: ./
      continue-on-error: true

    - name: Run daily visitor assignment (adds 50 visitors to completed campaigns)
      env:
        USERNAME: ${{ secrets.USERNAME }}
        PASSWORD: ${{ secrets.PASSWORD }}
      run: |
        echo "Starting daily visitor assignment at $(date)..."
        python dynamic_daily_visitor_assigner.py
        echo "Daily visitor assignment completed."

    - name: Save cookies for next run
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: session-cookies
        path: session_cookies.pkl
        retention-days: 1
